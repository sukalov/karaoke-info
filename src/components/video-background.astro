<div class="loading-screen overflow-x-hidden" id="loadingScreen">
  <div class="container">
    <ul class="loader">
      <li></li><li></li><li></li><li></li><li></li><li></li>
    </ul>
  </div>
</div>

<div class="video-fallback" id="videoFallback">
  <img
    src="/barka-fallback.jpg"
    alt="Живое караоке в ромочной 'Барка'"
    class="fallback-image"
  />
</div>

<video
  class="video-background overflow-x-hidden"
  id="bgVideo"
  autoplay
  muted
  loop
  playsinline
  preload="metadata"
  title='Живое караоке "Баркe"'
  aria-label='Живое караоке в ромочной "Барка", Гостинный двор, Москва, 2024'
>
  <!-- Progressive loading: start with compressed versions -->
  <source
    src="https://i65j0p78ch.ufs.sh/f/G5bUt43DiqIwztnRXa2VdeYZrjIPmconuM5LR80KTQbtJyi9"
    type="video/mp4"
    data-quality="360p"
  />
  <source
    src="https://i65j0p78ch.ufs.sh/f/G5bUt43DiqIwbaSnDxfjz6KN98mFsBMvn14ES75CP2Gl0qJf"
    type="video/mp4"
    data-quality="720p"
    media="(min-width: 768px)"
  />
  <!-- High-quality uncompressed version for fast connections (260MB) -->
  <source
    src="https://i65j0p78ch.ufs.sh/f/G5bUt43DiqIwz4kJsWVdeYZrjIPmconuM5LR80KTQbtJyi93"
    type="video/mp4"
    data-quality="uncompressed"
    data-high-quality="true"
  />
  Ваш браузер не поддерживает video тег.
</video>

<script>
  // Type declarations for network APIs
  declare global {
    interface Navigator {
      connection?: {
        effectiveType: string;
        downlink: number;
        addEventListener: (type: string, listener: () => void) => void;
      };
    }
  }

  const video = document.getElementById("bgVideo") as HTMLVideoElement;
  const loadingScreen = document.getElementById("loadingScreen");
  const videoFallback = document.getElementById("videoFallback") as HTMLElement;

  // Performance tracking
  let loadStartTime = performance.now();
  let loadTimeout: NodeJS.Timeout | null = null;
  let retryCount = 0;
  const maxRetries = 3;

  // Network speed measurement
  let networkSpeedTested = false;
  let measuredDownloadSpeed = 0;
  let highQualityVideoLoading = false;
  let highQualityVideoLoaded = false;

  // Disable body scrolling during video load
  document.body.style.overflow = "hidden";

  // Hide fallback image initially
  if (videoFallback) {
    videoFallback.style.display = "none";
  }

  function handleVideoLoaded() {
    const loadTime = performance.now() - loadStartTime;
    console.log(
      `Video loaded in ${Math.round(loadTime)}ms after ${retryCount} retries`,
    );

    video.classList.add("loaded");
    if (loadingScreen) {
      loadingScreen.classList.add("hidden");
    }

    // Hide fallback image
    if (videoFallback) {
      videoFallback.style.display = "none";
    }

    // Clear timeout if video loads successfully
    if (loadTimeout) {
      clearTimeout(loadTimeout);
      loadTimeout = null;
    }

    // Enable scrolling
    document.body.style.overflow = "auto";

    // Start progressive enhancement after initial load
    setTimeout(() => {
      enhanceVideoQuality();
    }, 2000);
  }

  function handleVideoError() {
    console.warn(`Video load failed, attempt ${retryCount + 1}/${maxRetries}`);

    if (retryCount < maxRetries) {
      retryCount++;
      // Retry with exponential backoff
      const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 5000);
      setTimeout(() => {
        video.load();
      }, retryDelay);
    } else {
      // Show fallback after all retries fail
      showFallback();
    }
  }

  async function measureNetworkSpeed() {
    if (networkSpeedTested || highQualityVideoLoading) return;

    console.log("Measuring network speed for quality enhancement...");
    networkSpeedTested = true;

    // Small file for speed test
    const testUrl =
      "https://i65j0p78ch.ufs.sh/f/G5bUt43DiqIwztnRXa2VdeYZrjIPmconuM5LR80KTQbtJyi9";
    const startTime = performance.now();

    try {
      const response = await fetch(testUrl, {
        method: "HEAD",
        cache: "no-cache",
      });

      if (response.ok) {
        const downloadTime = (performance.now() - startTime) / 1000;
        const fileSize = 18 * 1024 * 1024; // 18MB in bytes
        measuredDownloadSpeed = fileSize / downloadTime / (1024 * 1024); // MB/s

        console.log(
          `Measured download speed: ${measuredDownloadSpeed.toFixed(2)} MB/s`,
        );

        // Load high-quality video if speed is sufficient (>5 MB/s for 260MB file)
        if (measuredDownloadSpeed > 5) {
          loadHighQualityVideo();
        }
      }
    } catch (error) {
      console.warn("Network speed test failed:", error);
    }
  }

  function loadHighQualityVideo() {
    if (highQualityVideoLoading || highQualityVideoLoaded) return;

    console.log("Network speed is good, preloading high-quality video...");
    highQualityVideoLoading = true;

    const highQualitySource = video.querySelector(
      'source[data-high-quality="true"]',
    ) as HTMLSourceElement;
    if (!highQualitySource) return;

    // Create hidden video element for preloading
    const preloadVideo = document.createElement("video");
    preloadVideo.muted = true;
    preloadVideo.preload = "auto";
    preloadVideo.src = highQualitySource.src;

    // Add loading overlay for smooth transition
    const loadingOverlay = document.createElement("div");
    loadingOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    `;
    document.body.appendChild(loadingOverlay);

    // Show subtle loading overlay
    requestAnimationFrame(() => {
      loadingOverlay.style.opacity = "0.5";
    });

    preloadVideo.addEventListener(
      "canplaythrough",
      () => {
        console.log("High-quality video preloaded, switching seamlessly...");

        // Store current state and prepare for seamless switch
        const currentTime = video.currentTime;
        const wasPlaying = !video.paused;
        const currentVolume = video.volume;

        // Create smooth crossfade transition
        const smoothSwitch = async (): Promise<void> => {
          try {
            // Pause current video
            video.pause();

            // Load high quality video
            video.src = highQualitySource.src;

            // Wait for video to be ready
            await new Promise<void>((resolve) => {
              if (video.readyState >= 4) {
                resolve();
              } else {
                video.addEventListener("loadeddata", () => resolve(), {
                  once: true,
                });
              }
            });

            // Restore playback state
            video.currentTime = Math.min(currentTime, video.duration - 0.5);
            video.volume = currentVolume;

            // Fade out loading overlay
            loadingOverlay.style.opacity = "0";

            setTimeout(() => {
              document.body.removeChild(loadingOverlay);
            }, 300);

            // Resume playback
            if (wasPlaying) {
              const playPromise = video.play();
              if (playPromise !== undefined) {
                playPromise.catch((err) =>
                  console.log("Auto-play prevented after upgrade:", err),
                );
              }
            }

            highQualityVideoLoaded = true;
            highQualityVideoLoading = false;

            console.log(
              "Successfully upgraded to uncompressed high-quality video",
            );
          } catch (error) {
            console.error("Error during video switch:", error);
            loadingOverlay.style.opacity = "0";
            setTimeout(() => {
              if (document.body.contains(loadingOverlay)) {
                document.body.removeChild(loadingOverlay);
              }
            }, 300);
            highQualityVideoLoading = false;
          }
        };

        // Execute smooth switch
        smoothSwitch();
      },
      { once: true },
    );

    preloadVideo.addEventListener(
      "error",
      () => {
        console.log(
          "High-quality video failed to load, staying with current quality",
        );
        loadingOverlay.style.opacity = "0";
        setTimeout(() => {
          if (document.body.contains(loadingOverlay)) {
            document.body.removeChild(loadingOverlay);
          }
        }, 300);
        highQualityVideoLoading = false;
      },
      { once: true },
    );

    // Start preloading
    preloadVideo.load();
  }

  function showFallback() {
    console.log("Showing fallback image due to video load failure");
    if (loadingScreen) {
      loadingScreen.classList.add("hidden");
    }

    if (videoFallback) {
      videoFallback.style.display = "block";
    }

    document.body.style.overflow = "auto";
  }

  function enhanceVideoQuality() {
    const connection = navigator.connection;
    if (connection && !highQualityVideoLoading && !highQualityVideoLoaded) {
      if (connection.effectiveType === "4g" || connection.downlink > 5) {
        measureNetworkSpeed();

        // Also try 720p upgrade immediately
        const sources = video.querySelectorAll("source");
        const mediumQualitySource = Array.from(sources).find(
          (source) =>
            source.src.includes("720p") &&
            !source.hasAttribute("data-high-quality"),
        );

        if (mediumQualitySource && video.src !== mediumQualitySource.src) {
          console.log("Upgrading to 720p video");
          const currentTime = video.currentTime;
          const wasPlaying = !video.paused;
          const currentVolume = video.volume;

          // Smooth transition for 720p upgrade
          const smoothUpgrade = async () => {
            try {
              video.pause();
              video.src = mediumQualitySource.src;

              await new Promise((resolve) => {
                if (video.readyState >= 4) {
                  resolve();
                } else {
                  video.addEventListener("loadeddata", () => resolve(), {
                    once: true,
                  });
                }
              });

              video.currentTime = Math.min(currentTime, video.duration - 0.5);
              video.volume = currentVolume;

              if (wasPlaying) {
                const playPromise = video.play();
                if (playPromise !== undefined) {
                  playPromise.catch((err) =>
                    console.log("Auto-play prevented after 720p upgrade:", err),
                  );
                }
              }

              console.log("Successfully upgraded to 720p video");
            } catch (error) {
              console.error("Error during 720p upgrade:", error);
            }
          };

          smoothUpgrade();
        }
      }
    }
  }

  // Setup timeout mechanism
  loadTimeout = setTimeout(() => {
    console.warn("Video load timeout (10 seconds), showing fallback");
    showFallback();
  }, 10000);

  // Setup event listeners
  if (video.readyState >= 3) {
    handleVideoLoaded();
  } else {
    video.addEventListener("canplay", handleVideoLoaded, { once: true });
    video.addEventListener("error", handleVideoError, { once: true });
  }

  // Intersection Observer for performance optimization
  if ("IntersectionObserver" in window) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Video is visible, ensure it's playing
            if (video.paused) {
              video.play().catch((err) => {
                console.log("Auto-play prevented:", err);
              });
            }
          } else {
            // Video is not visible, pause to save bandwidth
            if (!video.paused) {
              video.pause();
            }
          }
        });
      },
      { threshold: 0.1 },
    );

    observer.observe(video);
  }

  // Network change handling
  const connection = navigator.connection;
  if (connection) {
    connection.addEventListener("change", () => {
      console.log(
        `Network changed: ${connection.effectiveType} ${connection.downlink}Mbps`,
      );

      if (
        connection.effectiveType === "slow-2g" ||
        connection.effectiveType === "2g"
      ) {
        showFallback();
      } else if (connection.effectiveType === "3g") {
        console.log("3G detected, staying with current quality");
      } else {
        if (!highQualityVideoLoaded) {
          measureNetworkSpeed();
        }
      }
    });
  }
</script>
<style>
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .video-fallback {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    display: none;
  }

  .fallback-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .video-background.loaded {
    opacity: 1;
  }

  .loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--color-background);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    transition: opacity 0.5s ease-in-out;
  }

  .loading-screen.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .container {
    z-index: 4;
    margin: 0 auto;
    left: 35px;
    right: 0;
    top: 50%;
    margin-top: -45px;
    width: 130px;
    height: 80px;
    list-style: none;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 40px;
  }
  .loader {
    position: fixed;
    z-index: 3;
    margin: 0 auto;
    left: 5px;
    right: 0;
    top: 50%;
    margin-top: -48px;
    width: 90px;
    height: 60px;
    list-style: none;
  }

  @keyframes loadbars {
    0% {
      height: 10px;
      margin-top: 25px;
    }
    50% {
      height: 50px;
      margin-top: 0px;
    }
    100% {
      height: 10px;
      margin-top: 25px;
    }
  }

  li {
    background-color: var(--color-secondary);
    width: 10px;
    height: 10px;
    float: right;
    margin-right: 5px;
    box-shadow: 0px 20px 10px rgba(0, 0, 0, 0.2);
  }

  li:first-child {
    animation: loadbars 1s cubic-bezier(0.645, 0.045, 0.355, 1) infinite;
  }

  li:nth-child(2) {
    animation: loadbars 1s ease-in-out infinite;
    animation-delay: -0.2s;
  }

  li:nth-child(3) {
    animation: loadbars 1s ease-in-out infinite;
    animation-delay: -0.4s;
  }

  li:nth-child(4) {
    animation: loadbars 1s ease-in-out infinite;
    animation-delay: -0.6s;
  }

  li:nth-child(5) {
    animation: loadbars 1s ease-in-out infinite;
    animation-delay: -0.8s;
  }

  li:nth-child(6) {
    animation: loadbars 1s ease-in-out infinite;
    animation-delay: -1s;
  }
</style>
